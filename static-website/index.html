<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Andos - Top 10 Anime</title>
<style>
  :root{ --accent:#00E5E6; --brand:#F47521; }
  *{ box-sizing:border-box; }
  body{ font-family:'Open Sans',sans-serif; margin:0; background:#000; color:#f0f0f0; }

  header{ background:var(--brand); color:#fff; padding:16px 20px; display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
  .logo-link{ text-decoration:none; display:flex; align-items:center; gap:10px; }
  .header-actions{ display:flex; gap:10px; align-items:center; position:relative; flex-wrap:wrap; }
  .header-actions input{ padding:8px 10px; border:none; border-radius:6px; outline:none; width:200px; }
  .header-actions button{ background:var(--accent); color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; font-weight:700; transition:filter .2s ease; }
  .header-actions button:hover{ filter:brightness(0.9); }
  .menu-btn{ background:transparent; border:2px solid var(--accent); }

  /* Suggestions dropdown */
  .suggestions{ position:absolute; top:38px; left:0; width:100%; background:#fff; color:#000; border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,.3); z-index:30; max-height:220px; overflow:auto; }
  .suggestion-item{ padding:8px 10px; cursor:pointer; }
  .suggestion-item:hover{ background:#eee; }

  /* Cards */
  .anime-card{ background:#1a1a1a; border-left:6px solid var(--brand); display:flex; gap:16px; border-radius:8px; box-shadow:0 2px 8px rgba(255,255,255,.05); color:#f0f0f0; padding:16px; margin:16px auto; max-width:900px; align-items:flex-start; }
  .anime-card img{ width:140px; aspect-ratio:2/3; object-fit:cover; border-radius:6px; flex:0 0 auto; }
  .anime-card h2{ margin:0; color:var(--brand); }
  .details{ flex:1; display:flex; flex-direction:column; gap:10px; }
  .meta p{ margin:4px 0; color:#ccc; }
  .actions{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .anime-card form{ margin:0; }
  .anime-card textarea{ width:100%; border-radius:6px; border:1px solid #333; background:#111; color:#eee; padding:8px; }

  section.intro{ max-width:900px; margin:28px auto 12px; padding:20px; background:#fff3e6; border-left:6px solid var(--accent); border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.05); color:#333; }
  section.intro h2{ margin-top:0; color:var(--brand); }

  h3.section-title{ text-align:center; color:#00E5E6; margin:24px 0; font-size:1.5em; }
  #loading{ text-align:center; margin:20px; font-size:1.1em; color:#00E5E6; }
  #searchResultsTitle{ text-align:center; font-size:1.4em; color:#00E5E6; margin-top:24px; }

  .pagination{ display:flex; justify-content:center; align-items:center; gap:10px; margin:16px 0 40px; }
  .pagination button{ padding:8px 12px; background:var(--accent); color:#fff; border:none; border-radius:4px; cursor:pointer; }
  .pagination button:disabled{ background:#444; cursor:not-allowed; }
  #pageNumber{ color:#fff; font-weight:700; text-align:center; min-width:120px; }

  footer{ background:var(--brand); color:#fff; text-align:center; padding:20px; margin-top:40px; }
  footer a{ color:#fff; text-decoration:underline; margin:0 10px; }

  /* Modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:100; }
  .modal{ width:min(92vw,420px); background:#111; border:1px solid #333; border-radius:12px; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,.6); position:relative; }
  .modal h2{ margin:0 0 10px; color:var(--accent); }
  .modal .notice{ font-size:.9em; color:#bbb; margin-bottom:12px; }
  .modal label{ display:block; margin:10px 0 6px; color:#ddd; }
  .modal input{ width:100%; padding:10px; border-radius:8px; border:1px solid #333; background:#1a1a1a; color:#eee; }
  .modal-actions{ display:flex; gap:10px; margin-top:16px; }
  .close-x{ position:absolute; top:12px; right:16px; background:transparent; border:none; color:#aaa; font-size:20px; cursor:pointer; }

  .hidden{ display:none !important; }

  @keyframes dropIn {
    from { transform: translateY(-16px); opacity: 0; }
    to   { transform: translateY(0);     opacity: 1; }
  }
  .modal.show { animation: dropIn .22s ease-out; }

  /* Reviews UI */
  .reviews-section { margin-top: 12px; padding-top: 8px; border-top: 1px solid #333; }
  .reviews-list { display:flex; flex-direction:column; gap:8px; }
  .review-item { background:#0d0d0d; border:1px solid #222; border-radius:6px; padding:8px; color:#ddd; cursor:default; }
  .review-item .meta { font-size:.85em; color:#aaa; margin-bottom:4px; }
  .review-item.mine { border-color:#444; }
  .review-item.mine .review-body { cursor:pointer; }
  .review-item.mine .review-body:hover { text-decoration: underline; }
  .inline-edit { margin-top:8px; display:none; }
  .inline-edit textarea{ width:100%; border-radius:6px; border:1px solid #333; background:#111; color:#eee; padding:8px; }
  .inline-edit .actions { display:flex; gap:8px; margin-top:6px; }
</style>
</head>
<body>

<header>
  <a href="#" class="logo-link" onclick="goHome(); return false;">
    <img src="https://raw.githubusercontent.com/IT-Yeti8/Andos_Reviews/main/static-website/Static%20Website%20Logo%20update.png" alt="Andos Logo" style="height: 90px;">
  </a>
  <div class="header-actions">
    <div style="position:relative;">
      <input type="text" id="animeInput" placeholder="Search anime..." autocomplete="off" />
      <div id="suggestions" class="suggestions"></div>
    </div>
    <button id="loginBtn" onclick="handleLoginButton()">Login</button>
    <span id="userStatus" style="font-size:0.9em; color:#ccc;"></span>
    <button class="menu-btn">‚ò∞ Menu</button>
  </div>
</header>

<div id="loading" style="display:none;">Searching...</div>

<section class="intro" id="introSection">
  <h2>Welcome to Andos</h2>
  <p>Andosssss is your go-to hub for anime reviews curated by fans, for fans. Discover top-rated shows, read short takes, and soon ‚Äî share your own thoughts too! This site showcases our Top 10 picks and is just the beginning.</p>
  <p>Stay tuned ‚Äî more community features coming soon!</p>
</section>

<h3 class="section-title" id="sectionTitle">Not my top 10 but some of my favorites</h3>

<div id="animeCards"></div>

<h3 id="searchResultsTitle" style="display:none;">Search Results</h3>
<div id="resultsContainer"></div>
<div class="pagination" id="paginationControls" style="display:none;">
  <button id="prevPage">Previous</button>
  <span id="pageNumber"></span>
  <button id="nextPage">Next</button>
</div>

<footer>
  <p>¬© 2025 Andos. Built for fans.</p>
  <p>
    <a href="#">About</a> |
    <a href="#">Contact</a> |
    <a href="#">GitHub</a>
  </p>
</footer>

<!-- LOGIN MODAL -->
<div id="loginBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
  <div class="modal" role="document">
    <button class="close-x" aria-label="Close" onclick="closeLoginModal()">‚úï</button>
    <h2 id="loginTitle">Login to Andos</h2>
    <p class="notice">Demo only ‚Äî use any username and password (no real auth yet).</p>
    <label for="loginUsername">Username</label>
    <input id="loginUsername" type="text" placeholder="e.g., AndosUser" />
    <label for="loginPassword">Password</label>
    <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div class="modal-actions">
      <button onclick="doLogin()">Login</button>
      <button onclick="closeLoginModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG / AUTH
========================= */
const API_BASE = "https://wye2tvd6fh.execute-api.us-east-1.amazonaws.com";

let LOGGED_IN = localStorage.getItem("loggedIn") === "true";
let PENDING_ACTION = null;

/* Identify user */
function currentUsername(){
  return (localStorage.getItem('username') || 'AndosUser').trim();
}
function isMine(reviewObj){
  const me = currentUsername().toLowerCase();
  const owner = (reviewObj.user || 'Anonymous').toLowerCase();
  return me && owner && me === owner;
}

/* =========================
   REVIEWS HELPERS
========================= */
function slugify(str){ return String(str).toLowerCase().replace(/[^a-z0-9]+/g,'-'); }
function reviewsMountId(title){ return `reviews-${slugify(title)}`; }

// Prevent XSS for user-submitted text
function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;').replaceAll('<','&lt;')
    .replaceAll('>','&gt;').replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

function normalizeReviews(raw){
  // Accept either: ["Great!","Okay"] OR [{review:"Great!", user:"Tim", createdAt:"..."}]
  if (!Array.isArray(raw)) return [];
  return raw.map(r=>{
    if (typeof r === 'string') return { review: r, user: 'Anonymous', createdAt: null };
    return {
      review: r.review ?? r.text ?? '',
      user: r.user ?? r.username ?? 'Anonymous',
      createdAt: r.createdAt ?? r.created_at ?? r.timestamp ?? null
    };
  }).filter(x=>x.review);
}

function renderReviews(title, rawReviews){
  const mount = document.getElementById(reviewsMountId(title));
  if (!mount) return;
  const reviews = normalizeReviews(rawReviews);

  if (!reviews.length){
    mount.innerHTML = `<em>No reviews yet. Be the first!</em>`;
    return;
  }

  const slug = slugify(title);

  mount.innerHTML = `
    <div class="reviews-list">
      ${reviews.map((r, idx) => {
        const mine = isMine(r);
        const safeUser = escapeHtml(r.user || 'Anonymous');
        const safeTime = r.createdAt ? ` ‚Ä¢ <span>${escapeHtml(String(r.createdAt))}</span>` : '';
        const safeText = escapeHtml(r.review || '');
        const editId = `edit-${slug}-${idx}`;
        return `
          <div class="review-item ${mine ? 'mine' : ''}" data-index="${idx}">
            <div class="meta"><strong>${safeUser}</strong>${safeTime}</div>
            <div class="review-body" ${mine ? `onclick="toggleInlineEdit('${title.replace(/'/g,"&#39;")}', ${idx})"` : ''}>
              ${safeText}
            </div>
            ${mine ? `
              <div class="inline-edit" id="${editId}">
                <textarea rows="3">${safeText}</textarea>
                <div class="actions">
                  <button type="button" onclick="submitInlineUpdate('${title.replace(/'/g,"&#39;")}', ${idx})">Update</button>
                  <button type="button" onclick="submitInlineDelete('${title.replace(/'/g,"&#39;")}')">Delete</button>
                  <button type="button" onclick="toggleInlineEdit('${title.replace(/'/g,"&#39;")}', ${idx}, true)">Cancel</button>
                </div>
              </div>
            ` : ``}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

async function fetchAndRenderReviews(title){
  const mount = document.getElementById(reviewsMountId(title));
  if (!mount) return;
  mount.innerHTML = `<em>Loading reviews...</em>`;
  try{
    const res = await fetch(`${API_BASE}/GetReviews?title=${encodeURIComponent(title)}`);
    let data;
    try { data = await res.json(); } catch { data = { raw: await res.text() }; }
    if (!res.ok){
      mount.innerHTML = `<em>Failed to load reviews (${res.status})</em>`;
      return;
    }
    const arr = (data && (data.reviews || data.data || (Array.isArray(data) && data))) || [];
    renderReviews(title, arr);
  }catch(err){
    console.error('GET reviews error:', err);
    mount.innerHTML = `<em>Network or CORS error loading reviews.</em>`;
  }
}

function refreshReviews(title){
  fetchAndRenderReviews(title);
}

/* Modal helpers */
function openLoginModal(pending){
  if(pending) PENDING_ACTION = pending;
  const backdrop = document.getElementById('loginBackdrop');
  const modal = backdrop.querySelector('.modal');
  backdrop.style.display = 'flex';
  modal.classList.remove('show'); void modal.offsetWidth; modal.classList.add('show');
  setTimeout(()=> document.getElementById('loginUsername').focus(), 50);
  backdrop.removeEventListener('click', onBackdropClick);
  document.removeEventListener('keydown', onEscClose);
  backdrop.addEventListener('click', onBackdropClick);
  document.addEventListener('keydown', onEscClose);
}
function closeLoginModal(){
  const backdrop = document.getElementById('loginBackdrop');
  backdrop.style.display = 'none';
  PENDING_ACTION = null;
  backdrop.removeEventListener('click', onBackdropClick);
  document.removeEventListener('keydown', onEscClose);
}
function onBackdropClick(e){ if(e.target === e.currentTarget) closeLoginModal(); }
function onEscClose(e){ if(e.key === 'Escape') closeLoginModal(); }
function handleLoginButton(){ if(!LOGGED_IN){ openLoginModal(); } else { doLogout(); } }
function doLogin(){
  const username = (document.getElementById('loginUsername').value || 'AndosUser').trim();
  LOGGED_IN = true;
  localStorage.setItem('loggedIn','true');
  localStorage.setItem('username', username);
  closeLoginModal();
  refreshAuthUI();
  if(PENDING_ACTION){
    const { name, payload } = PENDING_ACTION; PENDING_ACTION = null;
    if(name==='addToWatchlist') actuallyAddToWatchlist(payload.title);
    if(name==='share') actuallyShare(payload.title);
    if(name==='focusReview') payload.textarea.focus();
    if(name==='rate') alert('You rated ' + payload.title + ' ' + payload.selectEl.value);
  }
}
function doLogout(){
  LOGGED_IN = false;
  localStorage.setItem('loggedIn','false');
  localStorage.removeItem('username');
  refreshAuthUI();
  alert('Logged out');
}
function requireLogin(pending){
  if (!LOGGED_IN) { 
    openLoginModal(pending);
    return false;
  }
  return true;
}
function refreshAuthUI(){
  const loginBtn = document.getElementById('loginBtn');
  const username = localStorage.getItem('username') || 'User';
  const statusEl = document.getElementById('userStatus');

  if(loginBtn) loginBtn.textContent = LOGGED_IN ? `Logout` : 'Login';
  if(statusEl) statusEl.textContent = LOGGED_IN ? `(Logged in as ${username})` : '';

  document.querySelectorAll('.auth-only').forEach(el=> el.classList.toggle('hidden', !LOGGED_IN));
}

/* =========================
   DATA
========================= */
const animeList = [
  { title:"Dragon Ball Z", genre:"Action, Adventure", studio:"Toei Animation", release:"1989", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 9.6", description:"Iconic action-packed anime with legendary characters.", image:"https://cdn.myanimelist.net/images/anime/1277/142022.jpg" },
  { title:"Yu Yu Hakusho", genre:"Supernatural, Action", studio:"Pierrot", release:"1992", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 9.2", description:"Classic story of a teenage spirit detective.", image:"https://upload.wikimedia.org/wikipedia/en/b/b7/YuYu_Hakusho_1.png" },
  { title:"Haikyuu!!", genre:"Sports, Drama", studio:"Production I.G", release:"2014", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 9.3", description:"Heart-pounding volleyball battles and personal growth.", image:"https://upload.wikimedia.org/wikipedia/en/6/6b/Haiky%C5%AB_Volume_1.jpg" },
  { title:"Attack on Titan", genre:"Action, Drama", studio:"MAPPA/Wit Studio", release:"2013", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 9.8", description:"Humanity fights for survival against towering titans.", image:"https://upload.wikimedia.org/wikipedia/en/d/d6/Shingeki_no_Kyojin_manga_volume_1.jpg" },
  { title:"Hunter x Hunter", genre:"Adventure, Fantasy", studio:"Madhouse", release:"2011", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 9.7", description:"A boy seeks his father and becomes a hunter.", image:"https://upload.wikimedia.org/wikipedia/en/8/82/Hunter_%C3%97_Hunter_%282011%29.png" },
  { title:"Your Lie in April", genre:"Drama, Romance", studio:"A-1 Pictures", release:"2014", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 9.0", description:"A moving story of music, love, and loss.", image:"https://cdn.myanimelist.net/images/anime/3/67177.jpg" },
  { title:"One Piece", genre:"Adventure, Fantasy", studio:"Toei Animation", release:"1999", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 9.7", description:"A pirate's journey to become the King of the Pirates.", image:"https://cdn.myanimelist.net/images/anime/6/73245.jpg" },
  { title:"Demon Slayer", genre:"Action, Supernatural", studio:"Ufotable", release:"2019", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 9.5", description:"A boy fights demons to save his sister.", image:"https://upload.wikimedia.org/wikipedia/en/0/09/Demon_Slayer_-_Kimetsu_no_Yaiba%2C_volume_1.jpg" },
  { title:"Naruto", genre:"Ninja, Action", studio:"Studio Pierrot", release:"2002", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 9.1", description:"A ninja dreams of becoming Hokage.", image:"https://upload.wikimedia.org/wikipedia/en/9/94/NarutoCoverTankobon1.jpg" },
  { title:"Jujutsu Kaisen", genre:"Action, Dark Fantasy", studio:"MAPPA", release:"2020", rating:"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 9.4", description:"A student battles curses to save others.", image:"https://upload.wikimedia.org/wikipedia/en/4/46/Jujutsu_kaisen.jpg" }
];

/* =========================
   DOM REFS & STATE
========================= */
const input = document.getElementById('animeInput');
const suggestionsDiv = document.getElementById('suggestions');
const resultsTitle = document.getElementById('searchResultsTitle');
const resultsContainer = document.getElementById('resultsContainer');
const paginationControls = document.getElementById('paginationControls');
const loading = document.getElementById('loading');
const animeCards = document.getElementById('animeCards');
const introSection = document.getElementById('introSection');
const sectionTitle = document.getElementById('sectionTitle');
const prevBtn = document.getElementById('prevPage');
const nextBtn = document.getElementById('nextPage');
const pageNumber = document.getElementById('pageNumber');

let debounceTimeout; 
let currentQuery=''; 
let currentPage=1; 
let lastPage=1;

/* =========================
   UI: HOME CARDS
========================= */
function makeCardHTML(a){
  return `
    <img loading="lazy" src="${a.image}" alt="${a.title}" />
    <div class="details">
      <h2>${a.title}</h2>
      <div class="meta">
        <p><strong>Genre:</strong> ${a.genre}</p>
        <p><strong>Studio:</strong> ${a.studio}</p>
        <p><strong>Release:</strong> ${a.release}</p>
        <p><strong>Rating:</strong> ${a.rating}</p>
        <p>${a.description}</p>
      </div>
      <div class="actions">
        <button onclick="handleAddToWatchlist(${JSON.stringify(a.title)})">‚ûï Add to Watchlist</button>
        <label style="display:flex; align-items:center; gap:6px;">
          ‚≠ê Rate:
          <select onchange="handleRate(this, ${JSON.stringify(a.title)})">
            <option value="">Select</option>
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </label>
        <button onclick="handleShare(${JSON.stringify(a.title)})">üîó Share</button>
      </div>
      <form onsubmit="submitReview(event, ${JSON.stringify(a.title)})" class="review">
        <label>üìù Leave a Review:</label>
        <textarea rows="3" name="reviewText" placeholder="Type your thoughts..." required></textarea>
        <div class="actions"><button type="submit">Submit Review</button></div>
      </form>

      <div class="reviews-section">
        <h3 style="margin:10px 0; color: var(--accent);">Community Reviews</h3>
        <div id="${reviewsMountId(a.title)}"><em>Loading reviews...</em></div>
        <div class="actions" style="margin-top:8px;">
          <button type="button" onclick="refreshReviews(${JSON.stringify(a.title)})">‚Üª Refresh Reviews</button>
        </div>
      </div>
    </div>`;
}
function loadAnimeCards(){
  animeList.forEach(a=>{
    const div=document.createElement('div');
    div.className='anime-card';
    div.innerHTML=makeCardHTML(a);
    animeCards.appendChild(div);
    // Fetch initial reviews for home cards
    fetchAndRenderReviews(a.title);
  });
}

/* =========================
   SEARCH: suggestions & results
========================= */
input.addEventListener('input', function(){
  const query=input.value.trim(); 
  clearTimeout(debounceTimeout);
  if(!query){ suggestionsDiv.innerHTML=''; return; }
  debounceTimeout=setTimeout(()=>{
    fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(query)}&limit=5`)
      .then(r=>r.json())
      .then(data=>{
        suggestionsDiv.innerHTML='';
        (data.data||[]).forEach(anime=>{
          const item=document.createElement('div'); 
          item.className='suggestion-item'; 
          item.textContent=anime.title;
          item.onclick=()=>{ 
            input.value=anime.title; 
            suggestionsDiv.innerHTML=''; 
            currentQuery=anime.title; 
            currentPage=1; 
            performSearch(); 
          };
          suggestionsDiv.appendChild(item);
        });
      })
      .catch(()=>{ suggestionsDiv.innerHTML=''; });
  },300);
});
document.addEventListener('click', e=>{ if(!e.target.closest('.header-actions')) suggestionsDiv.innerHTML=''; });
input.addEventListener('keydown', e=>{ if(e.key==='Escape') suggestionsDiv.innerHTML=''; });
input.addEventListener('blur', ()=> setTimeout(()=> suggestionsDiv.innerHTML='', 150));
input.addEventListener('keypress', e=>{ 
  if(e.key==='Enter'){ 
    const q=input.value.trim(); 
    if(q){ 
      suggestionsDiv.innerHTML=''; 
      currentQuery=q; 
      currentPage=1; 
      performSearch(); 
    } 
  } 
});

/* results + pagination */
prevBtn.onclick=()=>{ if(currentPage>1){ currentPage--; performSearch(); } };
nextBtn.onclick=()=>{ if(currentPage<lastPage){ currentPage++; performSearch(); } };

function performSearch(){
  animeCards.style.display='none'; 
  introSection.style.display='none'; 
  sectionTitle.style.display='none';
  resultsTitle.style.display='block'; 
  loading.style.display='block'; 
  resultsContainer.innerHTML=''; 
  paginationControls.style.display='none';

  fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(currentQuery)}&limit=10&page=${currentPage}`)
    .then(res=>res.json())
    .then(data=>{
      loading.style.display='none'; 
      const items=(data&&data.data)?data.data:[];
      if(!items.length){ 
        resultsContainer.innerHTML="<p style='text-align:center;'>No results found.</p>"; 
        return; 
      }

      items.forEach(anime=>{
        const card=document.createElement('div'); 
        card.className='anime-card';
        const imgUrl=anime.images?.jpg?.image_url || 'https://via.placeholder.com/140x210?text=No+Image';
        card.innerHTML=`
          <img loading="lazy" src="${imgUrl}" alt="${anime.title || 'Anime'}" />
          <div class="details">
            <h2>${anime.title}</h2>
            <div class="meta">
              <p><strong>Score:</strong> ${anime.score ?? 'N/A'}</p>
              <p><strong>Episodes:</strong> ${anime.episodes ?? '??'}</p>
              <p><strong>Status:</strong> ${anime.status ?? '‚Äî'}</p>
              <p>${(anime.synopsis || 'No synopsis available.').slice(0, 250)}...</p>
            </div>

            <div class="actions">
              <button onclick="handleAddToWatchlist(${JSON.stringify(anime.title)})">‚ûï Add to Watchlist</button>
              <label style="display:flex; align-items:center; gap:6px;">
                ‚≠ê Rate:
                <select onchange="handleRate(this, ${JSON.stringify(anime.title)})">
                  <option value="">Select</option>
                  <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                </select>
              </label>
              <button onclick="handleShare(${JSON.stringify(anime.title)})">üîó Share</button>
            </div>

            <form onsubmit="submitReview(event, ${JSON.stringify(anime.title)})" class="review">
              <label>üìù Leave a Review:</label>
              <textarea rows="3" name="reviewText" placeholder="Type your thoughts..." required></textarea>
              <div class="actions"><button type="submit">Submit Review</button></div>
            </form>

            <div class="reviews-section">
              <h3 style="margin:10px 0; color: var(--accent);">Community Reviews</h3>
              <div id="${reviewsMountId(anime.title)}"><em>Loading reviews...</em></div>
              <div class="actions" style="margin-top:8px;">
                <button type="button" onclick="refreshReviews(${JSON.stringify(anime.title)})">‚Üª Refresh Reviews</button>
              </div>
            </div>
          </div>`;
        resultsContainer.appendChild(card);

        // Fetch initial reviews for this search result
        fetchAndRenderReviews(anime.title);
      });

      lastPage = data.pagination?.last_visible_page || 1; 
      pageNumber.textContent = `Page ${currentPage} of ${lastPage}`;
      paginationControls.style.display = 'flex'; 
      prevBtn.disabled = currentPage===1; 
      nextBtn.disabled = currentPage===lastPage;
      refreshAuthUI();
    })
    .catch(err=>{
      loading.textContent='Failed to load results.'; 
      console.error(err);
    });
}

/* =========================
   NAV: Go Home (logo)
========================= */
function goHome(){
  input.value=''; 
  currentQuery=''; 
  currentPage=1; 
  resultsContainer.innerHTML=''; 
  resultsTitle.style.display='none'; 
  loading.style.display='none';
  introSection.style.display='block'; 
  animeCards.style.display='block'; 
  sectionTitle.style.display='block'; 
  paginationControls.style.display='none';
  window.scrollTo({ top:0, behavior:'smooth' });
}

/* =========================
   Gated actions + API calls
========================= */
function handleAddToWatchlist(title){
  if (!requireLogin({ name:'addToWatchlist', payload:{ title } })) return;
  actuallyAddToWatchlist(title);
}
function handleShare(title){
  if (!requireLogin({ name:'share', payload:{ title } })) return;
  actuallyShare(title);
}
function handleRate(selectEl, title){
  if (!requireLogin({ name:'rate', payload:{ title, selectEl } })) {
    selectEl.value = "";
    return;
  }
  alert('You rated ' + title + ' ' + selectEl.value);
}

async function submitReview(event, animeTitle) {
  event.preventDefault();
  const textarea = event.target.reviewText;
  if (!requireLogin({ name: 'focusReview', payload: { textarea } })) return;
  const reviewText = textarea.value.trim();
  if (!reviewText) return;
  try {
    const res = await fetch(`${API_BASE}/AddReview`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title: animeTitle, review: reviewText, user: currentUsername() })
    });
    let data;
    try { data = await res.json(); } catch { data = { raw: await res.text() }; }
    if (!res.ok) return alert(`Submit failed: ${res.status}\n${JSON.stringify(data)}`);
    alert('Review submitted!');
    event.target.reset();
    // Refresh reviews
    fetchAndRenderReviews(animeTitle);
  } catch (err) {
    console.error('Submit error:', err);
    alert('Network or CORS error on POST.');
  }
}

/* Inline edit handlers */
function toggleInlineEdit(title, idx, forceClose=false){
  const slug = slugify(title);
  const el = document.getElementById(`edit-${slug}-${idx}`);
  if(!el) return;
  if(forceClose){ el.style.display = 'none'; return; }
  el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}
async function submitInlineUpdate(title, idx){
  const slug = slugify(title);
  const editBox = document.getElementById(`edit-${slug}-${idx}`);
  if(!editBox) return;
  const textarea = editBox.querySelector('textarea');
  const newText = textarea.value.trim();
  if(!newText) return alert('Please enter review text.');

  try {
    const res = await fetch(`${API_BASE}/UpdateReview`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, review: newText, user: currentUsername() })
    });
    let data;
    try { data = await res.json(); } catch { data = { raw: await res.text() }; }
    if (!res.ok) return alert(`Update failed: ${res.status}\n${JSON.stringify(data)}`);
    toggleInlineEdit(title, idx, true);
    fetchAndRenderReviews(title);
  } catch (e) {
    console.error(e);
    alert('Network or CORS error on PUT.');
  }
}
async function submitInlineDelete(title){
  if(!confirm('Delete your review for "' + title + '"?')) return;
  try {
    const res = await fetch(`${API_BASE}/DeleteReview?title=${encodeURIComponent(title)}`, {
      method: "DELETE"
    });
    let data;
    try { data = await res.json(); } catch { data = { raw: await res.text() }; }
    if (!res.ok) return alert(`Delete failed: ${res.status}\n${JSON.stringify(data)}`);
    fetchAndRenderReviews(title);
  } catch (e) {
    console.error(e);
    alert('Network or CORS error on DELETE.');
  }
}

/* Demo implementations */
function actuallyAddToWatchlist(title){
  alert(`Added "${title}" to your watchlist (demo).`);
}
function actuallyShare(title){
  const shareText = `Check out ${title} on Andos!`;
  if (navigator.share) {
    navigator.share({ title: 'Andos', text: shareText, url: location.href }).catch(()=>{});
  } else {
    navigator.clipboard.writeText(shareText + ' ' + location.href)
      .then(()=> alert('Share text copied to clipboard!'))
      .catch(()=> alert('Could not copy share text.'));
  }
}

/* =========================
   INIT
========================= */
window.onload=function(){ 
  loadAnimeCards(); 
  refreshAuthUI(); 
};
</script>
</body>
</html>
